name: Deploy to Environments

on:
  push:
    branches: [main]

env:
  STAGING_URL: "https://staging-app.herokuapp.com"
  PROD_URL: "https://prod-app.herokuapp.com"

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Deploy to Staging Environment
      run: |
        echo "ðŸš€ Deploying to STAGING environment"
        echo "Environment: staging"
        echo "Staging URL: $STAGING_URL"
        echo "ENVIRONMENT=staging" >> $GITHUB_ENV
        python app.py &
        sleep 2
        curl -f http://localhost:8001/health
        pkill -f "python app.py"
        echo "âœ… Staging deployment completed"

  deploy-production:
    runs-on: ubuntu-latest
    environment: production  
    needs: deploy-staging
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Production Pre-deployment Tests
      run: |
        pip install pytest
        pytest test_calculator.py -v
    - name: Deploy to Production Environment
      run: |
        echo "ðŸš€ Deploying to PRODUCTION environment"
        echo "Environment: production"
        echo "Production URL: $PROD_URL"
        echo "ENVIRONMENT=production" >> $GITHUB_ENV
        python app.py &
        sleep 2
        curl -f http://localhost:8001/health
        pkill -f "python app.py"
        echo "âœ… Production deployment completed"